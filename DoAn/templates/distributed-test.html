<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CockroachDB - H·ªá th·ªëng ph√¢n t√°n</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <style>
        body {
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .main-container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .card {
            margin-bottom: 20px;
            border: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        .card:hover {
            transform: translateY(-5px);
        }
        .node-card {
            border-left: 4px solid #28a745;
        }
        .node-card.offline {
            border-left: 4px solid #dc3545;
            opacity: 0.7;
        }
        .stat-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 15px;
        }
        .stat-value {
            font-size: 36px;
            font-weight: bold;
        }
        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }
        .query-result {
            background: #f8f9fa;
            border-left: 4px solid #007bff;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .explain-plan {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .timeline {
            position: relative;
            padding: 20px 0;
        }
        .timeline-item {
            padding: 20px;
            border-left: 3px solid #007bff;
            margin-left: 20px;
            margin-bottom: 20px;
        }
        .badge-node {
            font-size: 14px;
            padding: 5px 10px;
        }
        .comparison-table {
            width: 100%;
        }
        .comparison-table th {
            background: #007bff;
            color: white;
            text-align: center;
        }
        .comparison-table td {
            text-align: center;
            padding: 10px;
        }
        .faster {
            background: #d4edda;
            font-weight: bold;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .range-visualization {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 15px 0;
        }
        .range-item {
            background: #e9ecef;
            padding: 10px;
            border-radius: 5px;
            flex: 1;
            min-width: 200px;
            border-left: 4px solid #007bff;
        }
        .replica-badge {
            display: inline-block;
            padding: 3px 8px;
            background: #28a745;
            color: white;
            border-radius: 3px;
            margin: 2px;
            font-size: 11px;
        }
    </style>
</head>
<body>
    <!-- Navigation Menu -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-3">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <i class="bi bi-hospital"></i> H·ªá Th·ªëng Qu·∫£n L√Ω B·ªánh Nh√¢n
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                    aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">
                            <i class="bi bi-house-door"></i> Trang Ch·ªß
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/cache-test">
                            <i class="bi bi-speedometer2"></i> Ki·ªÉm Tra Cache
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/distributed-test">
                            <i class="bi bi-diagram-3"></i> Ki·ªÉm Tra Ph√¢n T√°n
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="main-container">
            <h1 class="mb-4">
                <i class="bi bi-server"></i>
                CockroachDB - H·ªá th·ªëng C∆° s·ªü D·ªØ li·ªáu Ph√¢n t√°n
            </h1>

            <!-- Cluster Overview -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="stat-box">
                        <div class="stat-value" id="totalNodes">-</div>
                        <div class="stat-label">T·ªïng s·ªë Node</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-box" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                        <div class="stat-value" id="totalRanges">-</div>
                        <div class="stat-label">T·ªïng s·ªë Ranges</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-box" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                        <div class="stat-value" id="avgReplicas">-</div>
                        <div class="stat-label">Trung b√¨nh Replicas</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-box" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                        <div class="stat-value" id="replicationStatus">-</div>
                        <div class="stat-label">Tr·∫°ng th√°i</div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-12 mb-3">
                    <button class="btn btn-primary" onclick="loadAllData()">
                        <i class="bi bi-arrow-clockwise"></i> L√†m m·ªõi t·∫•t c·∫£
                    </button>
                </div>
            </div>

            <!-- Node Information -->
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-hdd-network"></i> 
                        1. Th√¥ng tin c√°c Node trong Cluster
                    </h5>
                </div>
                <div class="card-body">
                    <div id="nodesList" class="row">
                        <div class="col-12 text-center">
                            <div class="loading"></div> ƒêang t·∫£i...
                        </div>
                    </div>
                </div>
            </div>

            <!-- Distributed Query Test -->
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-diagram-3"></i> 
                        2. Danh s√°ch B·ªánh nh√¢n theo Node
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <p class="text-muted">Hi·ªÉn th·ªã danh s√°ch b·ªánh nh√¢n t·ª´ t·ª´ng node ƒëang ho·∫°t ƒë·ªông</p>
                    </div>
                    <button class="btn btn-primary" onclick="loadPatientsByNode()">
                        <i class="bi bi-people-fill"></i> T·∫£i danh s√°ch b·ªánh nh√¢n
                    </button>
                    <div id="patientsByNodeResult" class="mt-3"></div>
                </div>
            </div>

            <!-- Local vs Distributed Comparison -->
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-speedometer2"></i> 
                        3. So s√°nh Truy v·∫•n C·ª•c b·ªô vs Ph√¢n t√°n
                    </h5>
                </div>
                <div class="card-body">
                    <button class="btn btn-info" onclick="compareQueries()">
                        <i class="bi bi-bar-chart-fill"></i> Ch·∫°y so s√°nh
                    </button>
                    <div id="comparisonResult" class="mt-3"></div>
                </div>
            </div>

            <!-- Replication & Synchronization -->
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">
                        <i class="bi bi-arrow-repeat"></i> 
                        4. Sao ch√©p & ƒê·ªìng b·ªô D·ªØ li·ªáu (Replication)
                    </h5>
                </div>
                <div class="card-body">
                    <button class="btn btn-warning" onclick="showReplication()">
                        <i class="bi bi-diagram-2"></i> Xem ph√¢n b·ªë d·ªØ li·ªáu
                    </button>
                    <div id="replicationInfo" class="mt-3"></div>
                </div>
            </div>

            <!-- Data Distribution -->
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-table"></i> 
                        5. Ph√¢n b·ªë B·∫£ng d·ªØ li·ªáu tr√™n c√°c Node
                    </h5>
                </div>
                <div class="card-body">
                    <button class="btn btn-secondary" onclick="showTableDistribution()">
                        <i class="bi bi-pie-chart"></i> Xem ph√¢n b·ªë
                    </button>
                    <div id="tableDistribution" class="mt-3"></div>
                </div>
            </div>

            <!-- Failover Test -->
            <div class="card">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-exclamation-triangle"></i> 
                        6. Test Failover & X·ª≠ l√Ω L·ªói
                    </h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-warning">
                        <i class="bi bi-info-circle"></i> 
                        Test n√†y m√¥ ph·ªèng ghi d·ªØ li·ªáu v√† ki·ªÉm tra c∆° ch·∫ø failover khi m·ªôt node b·ªã ng·∫Øt k·∫øt n·ªëi.
                    </div>
                    <button class="btn btn-danger" onclick="runFailoverTest()">
                        <i class="bi bi-shield-exclamation"></i> Ch·∫°y Failover Test
                    </button>
                    <div id="failoverResult" class="mt-3"></div>
                </div>
            </div>

            <!-- Consistency Check -->
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-check-circle"></i> 
                        7. Ki·ªÉm tra T√≠nh Nh·∫•t qu√°n (Consistency Check)
                    </h5>
                </div>
                <div class="card-body">
                    <button class="btn btn-dark" onclick="checkConsistency()">
                        <i class="bi bi-clipboard-check"></i> Ki·ªÉm tra nh·∫•t qu√°n
                    </button>
                    <div id="consistencyResult" class="mt-3"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE = window.location.origin;

        function initTooltips() {
            if (typeof bootstrap === 'undefined' || !bootstrap.Tooltip) {
                return;
            }
            document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => {
                if (el._tooltipInstance) {
                    el._tooltipInstance.dispose();
                }
            });
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.forEach(triggerEl => {
                triggerEl._tooltipInstance = new bootstrap.Tooltip(triggerEl);
            });
        }

        // Load all data on page load
        async function loadAllData() {
            await loadNodes();
            await loadReplicationStats();
        }

        // Load cluster nodes
        async function loadNodes() {
            try {
                const response = await fetch(`${API_BASE}/api/cluster/nodes`);
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('totalNodes').textContent = data.count;
                    
                    let html = '';
                    data.nodes.forEach(node => {
                        const statusClass = node.is_live ? '' : 'offline';
                        const statusIcon = node.is_live ? 
                            '<i class="bi bi-check-circle-fill text-success"></i>' : 
                            '<i class="bi bi-x-circle-fill text-danger"></i>';
                        
                        html += `
                            <div class="col-md-6 mb-3">
                                <div class="card node-card ${statusClass}">
                                    <div class="card-body">
                                        <h5>
                                            ${statusIcon}
                                            ${node.address} (n${node.node_id})
                                        </h5>
                                        <div class="row mb-2">
                                            <div class="col-6">
                                                <span class="badge ${node.is_live ? 'bg-success' : 'bg-danger'} px-3 py-2">
                                                    ${node.is_live ? '‚óè LIVE' : '‚óè DEAD'}
                                                </span>
                                            </div>
                                            <div class="col-6 text-end">
                                                <span class="badge bg-info px-3 py-2">${node.server_version || 'N/A'}</span>
                                            </div>
                                        </div>
                                        ${node.is_draining ? '<div class="alert alert-warning py-1 px-2 mb-2"><small><i class="bi bi-exclamation-triangle"></i> Draining</small></div>' : ''}
                                        <table class="table table-sm table-borderless mb-0">
                                            <tr>
                                                <td width="40%"><strong>Uptime:</strong></td>
                                                <td>${node.uptime}</td>
                                            </tr>
                                            <tr>
                                                <td><strong>Membership:</strong></td>
                                                <td>
                                                    <span class="badge ${node.membership === 'active' ? 'bg-success' : 'bg-warning'}">
                                                        ${node.membership}
                                                    </span>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td><strong>Locality:</strong></td>
                                                <td>${node.locality}</td>
                                            </tr>
                                            ${node.epoch ? `<tr><td><strong>Epoch:</strong></td><td>${node.epoch}</td></tr>` : ''}
                                            <tr>
                                                <td><strong>Available:</strong></td>
                                                <td>${node.is_available ? '<span class="text-success">‚úì Yes</span>' : '<span class="text-danger">‚úó No</span>'}</td>
                                            </tr>
                                        </table>
                                        <div class="mt-2">
                                            <small class="text-muted">Last updated: ${node.updated_at || 'N/A'}</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    document.getElementById('nodesList').innerHTML = html;
                } else {
                    document.getElementById('nodesList').innerHTML = 
                        '<div class="alert alert-danger">L·ªói: ' + data.error + '</div>';
                }
            } catch (error) {
                console.error('Error loading nodes:', error);
                document.getElementById('nodesList').innerHTML = 
                    '<div class="alert alert-danger">L·ªói k·∫øt n·ªëi: ' + error.message + '</div>';
            }
        }

        // Load replication stats
        async function loadReplicationStats() {
            try {
                const response = await fetch(`${API_BASE}/api/cluster/replication`);
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('totalRanges').textContent = data.total_ranges;
                    document.getElementById('avgReplicas').textContent = data.avg_replicas.toFixed(1);
                    
                    const percentage = (data.replicated_ranges / data.total_ranges * 100).toFixed(0);
                    document.getElementById('replicationStatus').textContent = percentage + '%';
                }
            } catch (error) {
                console.error('Error loading replication stats:', error);
            }
        }

        // Load patients by node
        async function loadPatientsByNode() {
            const resultDiv = document.getElementById('patientsByNodeResult');
            resultDiv.innerHTML = '<div class="loading"></div> ƒêang t·∫£i...';
            
            try {
                // First, get list of live nodes
                const nodesResponse = await fetch(`${API_BASE}/api/cluster/nodes`);
                const nodesData = await nodesResponse.json();
                
                if (!nodesData.success) {
                    throw new Error(nodesData.error);
                }
                
                const liveNodes = nodesData.nodes.filter(node => node.is_live);
                
                if (liveNodes.length === 0) {
                    resultDiv.innerHTML = '<div class="alert alert-warning">Kh√¥ng c√≥ node n√†o ƒëang ho·∫°t ƒë·ªông</div>';
                    return;
                }
                
                let html = '';
                
                // Load patients from each live node
                for (const node of liveNodes) {
                    const response = await fetch(`${API_BASE}/api/cluster/patients-by-node/${node.node_id}`);
                    const data = await response.json();
                    
                    if (data.success) {
                        html += `
                            <div class="card mb-3">
                                <div class="card-header bg-primary text-white">
                                    <h6 class="mb-0">
                                        <i class="bi bi-hdd-network"></i> 
                                        Node ${node.node_id}: ${node.address}
                                        <span class="badge bg-light text-dark ms-2">${data.total} b·ªánh nh√¢n</span>
                                        <span class="badge bg-info ms-2">${data.execution_time_ms} ms</span>
                                    </h6>
                                </div>
                                <div class="card-body">
                        `;
                        
                        if (data.patients.length > 0) {
                            html += `
                                <div class="table-responsive">
                                    <table class="table table-striped table-hover">
                                        <thead>
                                            <tr>
                                                <th>STT</th>
                                                <th>H·ªç t√™n</th>
                                                <th>Gi·ªõi t√≠nh</th>
                                                <th>NƒÉm sinh</th>
                                                <th>SƒêT</th>
                                                <th>T·ªânh/Th√†nh</th>
                                                <th>X√£/Ph∆∞·ªùng</th>
                                                <th>S·ªë l·∫ßn kh√°m</th>
                                                <th>Ng√†y t·∫°o</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                            `;
                            
                            data.patients.forEach((patient, index) => {
                                html += `
                                    <tr>
                                        <td>${index + 1}</td>
                                        <td><strong>${patient.ho_ten}</strong></td>
                                        <td>${patient.gioi_tinh}</td>
                                        <td>${patient.ngay_sinh || 'N/A'}</td>
                                        <td>${patient.so_dien_thoai || 'N/A'}</td>
                                        <td>${patient.tinh || 'N/A'}</td>
                                        <td>${patient.xa || 'N/A'}</td>
                                        <td><span class="badge bg-info">${patient.total_visits}</span></td>
                                        <td><small>${patient.created_at}</small></td>
                                    </tr>
                                `;
                            });
                            
                            html += `
                                        </tbody>
                                    </table>
                                </div>
                            `;
                        } else {
                            html += '<div class="alert alert-info">Kh√¥ng c√≥ d·ªØ li·ªáu b·ªánh nh√¢n</div>';
                        }
                        
                        html += `
                                </div>
                            </div>
                        `;
                    } else {
                        html += `
                            <div class="alert alert-danger">
                                <strong>Node ${node.node_id}:</strong> ${data.error}
                            </div>
                        `;
                    }
                }
                
                resultDiv.innerHTML = html;
                
            } catch (error) {
                resultDiv.innerHTML = '<div class="alert alert-danger">L·ªói: ' + error.message + '</div>';
            }
        }

        // Run distributed query
        async function runDistributedQuery() {
            const queryType = document.getElementById('distributedQueryType').value;
            const resultDiv = document.getElementById('distributedQueryResult');
            resultDiv.innerHTML = '<div class="loading"></div> ƒêang th·ª±c thi truy v·∫•n...';
            
            try {
                const response = await fetch(`${API_BASE}/api/cluster/distributed-query`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query_type: queryType })
                });
                const data = await response.json();
                
                if (data.success) {
                    let html = `
                        <div class="query-result">
                            <h6><i class="bi bi-lightning-fill"></i> K·∫øt qu·∫£ truy v·∫•n</h6>
                            <p><strong>Th·ªùi gian th·ª±c thi:</strong> ${data.execution_time_ms} ms</p>
                            <p><strong>Lo·∫°i:</strong> ${data.query_type}</p>
                            <p><strong>K·∫øt qu·∫£:</strong></p>
                            <pre>${JSON.stringify(data.result.data, null, 2)}</pre>
                        </div>
                        <div class="mt-3">
                            <h6><i class="bi bi-diagram-3"></i> Execution Plan (EXPLAIN):</h6>
                            <div class="explain-plan">
                                ${data.explain_plan.join('\n')}
                            </div>
                        </div>
                    `;
                    resultDiv.innerHTML = html;
                } else {
                    resultDiv.innerHTML = '<div class="alert alert-danger">L·ªói: ' + data.error + '</div>';
                }
            } catch (error) {
                resultDiv.innerHTML = '<div class="alert alert-danger">L·ªói: ' + error.message + '</div>';
            }
        }

        // Compare queries
        async function compareQueries() {
            const resultDiv = document.getElementById('comparisonResult');
            resultDiv.innerHTML = '<div class="loading"></div> ƒêang ch·∫°y so s√°nh...';
            
            try {
                // Run local query (direct query, processed by single node)
                const localStart = performance.now();
                const localResponse = await fetch(`${API_BASE}/api/benhnhan`);
                const localData = await localResponse.json();
                const localTime = performance.now() - localStart;
                
                // Run distributed query (query aggregated from multiple nodes)
                const distResponse = await fetch(`${API_BASE}/api/cluster/patients-distributed`);
                const distData = await distResponse.json();
                const distTime = distData.execution_time_ms || 0;
                
                const speedup = localTime > distTime ? ((localTime - distTime) / localTime * 100).toFixed(1) : 0;
                const isFaster = distTime < localTime;

                const localQueryTooltip = 'Endpoint: <code>GET /api/benhnhan</code><br>SQL: <code>SELECT * FROM benhnhan ORDER BY ho_ten DESC</code><br>Executor: Node leaseholder hi·ªán t·∫°i';
                const localPipelineTooltip = 'Lu·ªìng x·ª≠ l√Ω: Browser ‚Üí Flask ‚Üí node ƒëang active ‚Üí tr·∫£ JSON.<br>Kh√¥ng fan-out sang node kh√°c, to√†n b·ªô d·ªØ li·ªáu ƒë·ªçc t·ª´ m·ªôt leaseholder.';
                const distQueryTooltip = 'Endpoint: <code>GET /api/cluster/patients-distributed</code><br>SQL: <code>SELECT b.*, t.ten_tinh, x.ten_xa, COUNT(l.id)</code><br>Executor: CockroachDB DistSQL (coordinator fan-out t·ªõi c√°c replica)';
                const distPipelineTooltip = `Lu·ªìng x·ª≠ l√Ω: Browser ‚Üí Flask ‚Üí coordinator node ‚Üí fan-out t·ªõi ${distData.nodes_used || 'nhi·ªÅu'} nodes ‚Üí t·ªïng h·ª£p k·∫øt qu·∫£ song song.`;
                
                let html = `
                    <table class="table comparison-table">
                        <thead>
                            <tr>
                                <th>Lo·∫°i truy v·∫•n</th>
                                <th>Th·ªùi gian (ms)</th>
                                <th>Ghi ch√∫</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="${localTime < distTime ? 'faster' : ''}">
                                <td>
                                    <strong>Truy v·∫•n C·ª•c b·ªô</strong>
                                    <span class="ms-1 text-primary" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-html="true" data-bs-title="${localQueryTooltip}">
                                        <i class="bi bi-question-circle-fill"></i>
                                    </span>
                                </td>
                                <td>${localTime.toFixed(2)} ms</td>
                                <td>
                                    <span data-bs-toggle="tooltip" data-bs-placement="top" data-bs-html="true" data-bs-title="${localPipelineTooltip}">
                                        Truy v·∫•n tr·ª±c ti·∫øp t·ª´ m·ªôt node (${Array.isArray(localData) ? localData.length : 0} b·ªánh nh√¢n)
                                    </span>
                                </td>
                            </tr>
                            <tr class="${distTime < localTime ? 'faster' : ''}">
                                <td>
                                    <strong>Truy v·∫•n Ph√¢n t√°n</strong>
                                    <span class="ms-1 text-primary" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-html="true" data-bs-title="${distQueryTooltip}">
                                        <i class="bi bi-question-circle-fill"></i>
                                    </span>
                                </td>
                                <td>${distTime.toFixed(2)} ms ${isFaster ? '<span class="badge bg-success ms-2">‚ö° Nhanh h∆°n ' + speedup + '%</span>' : ''}</td>
                                <td>
                                    <span data-bs-toggle="tooltip" data-bs-placement="top" data-bs-html="true" data-bs-title="${distPipelineTooltip}">
                                        Truy v·∫•n t·ªïng h·ª£p t·ª´ ${distData.nodes_used || 'nhi·ªÅu'} node (${distData.total || 0} b·ªánh nh√¢n)
                                    </span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> 
                        <strong>Th√¥ng tin ph√¢n t√°n:</strong> 
                        ${distData.success && distData.live_nodes ? 
                            `D·ªØ li·ªáu ƒë∆∞·ª£c l·∫•y t·ª´ ${distData.nodes_used} node: ${distData.live_nodes.map(n => `Node ${n.node_id}`).join(', ')}` : 
                            'Th√¥ng tin node kh√¥ng kh·∫£ d·ª•ng'}
                    </div>
                    
                    ${isFaster ? `
                    <div class="card border-success mb-3">
                        <div class="card-header bg-success text-white">
                            <h6 class="mb-0">
                                <i class="bi bi-lightning-fill"></i> 
                                T·∫°i sao Truy v·∫•n Ph√¢n t√°n NHANH H∆†N?
                            </h6>
                        </div>
                        <div class="card-body">
                            <h6>üîπ 1. X·ª≠ l√Ω Song song (Parallel Processing)</h6>
                            <ul>
                                <li><strong>Chia nh·ªè c√¥ng vi·ªác:</strong> CockroachDB t·ª± ƒë·ªông ph√¢n chia d·ªØ li·ªáu th√†nh c√°c ranges nh·ªè</li>
                                <li><strong>Nhi·ªÅu node c√πng x·ª≠ l√Ω:</strong> Thay v√¨ 1 node x·ª≠ l√Ω h·∫øt, ${distData.nodes_used} node c√πng l√†m vi·ªác ƒë·ªìng th·ªùi</li>
                                <li><strong>K·∫øt h·ª£p k·∫øt qu·∫£:</strong> Coordinator node t·ªïng h·ª£p k·∫øt qu·∫£ t·ª´ c√°c node worker</li>
                            </ul>
                            
                            <h6>üîπ 2. Data Locality (D·ªØ li·ªáu g·∫ßn g≈©i)</h6>
                            <ul>
                                <li><strong>Replica g·∫ßn nh·∫•t:</strong> M·ªói truy v·∫•n ƒë∆∞·ª£c route ƒë·∫øn replica g·∫ßn nh·∫•t (th·∫•p latency)</li>
                                <li><strong>Leaseholder optimization:</strong> Node gi·ªØ lease x·ª≠ l√Ω read requests nhanh h∆°n</li>
                                <li><strong>Gi·∫£m network I/O:</strong> D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c ph√¢n t√°n, kh√¥ng c·∫ßn transfer gi·ªØa c√°c node</li>
                            </ul>
                            
                            <h6>üîπ 3. Distributed SQL Engine</h6>
                            <ul>
                                <li><strong>DistSQL:</strong> Query executor ƒë∆∞·ª£c t·ªëi ∆∞u cho m√¥i tr∆∞·ªùng ph√¢n t√°n</li>
                                <li><strong>Pushdown optimization:</strong> Filter v√† aggregation ƒë∆∞·ª£c th·ª±c hi·ªán ngay t·∫°i node l∆∞u d·ªØ li·ªáu</li>
                                <li><strong>Vectorized execution:</strong> X·ª≠ l√Ω h√†ng lo·∫°t rows c√πng l√∫c thay v√¨ t·ª´ng row</li>
                            </ul>
                            
                            <h6>üîπ 4. Load Balancing</h6>
                            <ul>
                                <li><strong>Ph√¢n t·∫£i t·ª± ƒë·ªông:</strong> Requests ƒë∆∞·ª£c ph√¢n ph·ªëi ƒë·ªÅu tr√™n ${distData.nodes_used} nodes</li>
                                <li><strong>Tr√°nh hotspot:</strong> Kh√¥ng c√≥ node n√†o b·ªã qu√° t·∫£i</li>
                                <li><strong>S·ª≠ d·ª•ng t√†i nguy√™n t·ªëi ƒëa:</strong> CPU, RAM, Disk I/O c·ªßa t·∫•t c·∫£ nodes ƒë∆∞·ª£c d√πng hi·ªáu qu·∫£</li>
                            </ul>
                            
                            <h6>üîπ 5. Caching & Indexing</h6>
                            <ul>
                                <li><strong>Distributed cache:</strong> M·ªói node c√≥ cache ri√™ng, t·ªïng cache = ${distData.nodes_used}x l·ªõn h∆°n</li>
                                <li><strong>Index locality:</strong> Index ƒë∆∞·ª£c l∆∞u c√πng data, truy c·∫≠p nhanh</li>
                                <li><strong>Range cache:</strong> Metadata v·ªÅ v·ªã tr√≠ ranges ƒë∆∞·ª£c cache ƒë·ªÉ routing nhanh</li>
                            </ul>
                            
                            <div class="alert alert-warning mb-0 mt-3">
                                <strong>‚ö†Ô∏è L∆∞u √Ω:</strong> Trong m·ªôt s·ªë tr∆∞·ªùng h·ª£p, truy v·∫•n c·ª•c b·ªô c√≥ th·ªÉ nhanh h∆°n n·∫øu:
                                <ul class="mb-0">
                                    <li>D·ªØ li·ªáu nh·ªè, v·ª´a v·ªõi 1 node</li>
                                    <li>Network latency gi·ªØa c√°c node cao</li>
                                    <li>Chi ph√≠ coordinate v√† merge k·∫øt qu·∫£ l·ªõn h∆°n l·ª£i √≠ch song song</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    ` : `
                    <div class="card border-primary mb-3">
                        <div class="card-header bg-primary text-white">
                            <h6 class="mb-0">
                                <i class="bi bi-info-circle"></i> 
                                T·∫°i sao Truy v·∫•n C·ª•c b·ªô nhanh h∆°n trong tr∆∞·ªùng h·ª£p n√†y?
                            </h6>
                        </div>
                        <div class="card-body">
                            <h6>C√°c y·∫øu t·ªë ·∫£nh h∆∞·ªüng:</h6>
                            <ul>
                                <li><strong>Overhead ph√¢n t√°n:</strong> Chi ph√≠ coordinate gi·ªØa ${distData.nodes_used} nodes</li>
                                <li><strong>Network latency:</strong> Th·ªùi gian truy·ªÅn d·ªØ li·ªáu gi·ªØa c√°c nodes</li>
                                <li><strong>Dataset nh·ªè:</strong> D·ªØ li·ªáu c√≥ th·ªÉ v·ª´a v·ªõi cache c·ªßa 1 node</li>
                                <li><strong>Merge cost:</strong> Chi ph√≠ t·ªïng h·ª£p k·∫øt qu·∫£ t·ª´ nhi·ªÅu nodes</li>
                            </ul>
                            
                            <div class="alert alert-info mb-0">
                                <strong>üí° Khi n√†o ph√¢n t√°n nhanh h∆°n?</strong>
                                <ul class="mb-0">
                                    <li>Dataset l·ªõn (h√†ng tri·ªáu/t·ª∑ rows)</li>
                                    <li>Query ph·ª©c t·∫°p v·ªõi nhi·ªÅu JOIN, aggregation</li>
                                    <li>D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c ph√¢n b·ªë ƒë·ªÅu tr√™n nhi·ªÅu ranges</li>
                                    <li>C√≥ nhi·ªÅu concurrent requests (load cao)</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    `}
                    
                    <div class="alert alert-secondary">
                        <i class="bi bi-speedometer2"></i> 
                        <strong>T√≥m t·∫Øt hi·ªáu su·∫•t:</strong> 
                        Ch√™nh l·ªách th·ªùi gian: <strong>${Math.abs(localTime - distTime).toFixed(2)} ms</strong>
                        ${isFaster ? 
                            ` - Truy v·∫•n ph√¢n t√°n nhanh h∆°n <strong>${speedup}%</strong> nh·ªù x·ª≠ l√Ω song song tr√™n ${distData.nodes_used} nodes.` : 
                            ' - Truy v·∫•n c·ª•c b·ªô nhanh h∆°n do dataset nh·ªè v√† overhead ph√¢n t√°n.'}
                    </div>
                `;
                
                resultDiv.innerHTML = html;
                initTooltips();
            } catch (error) {
                resultDiv.innerHTML = '<div class="alert alert-danger">L·ªói: ' + error.message + '</div>';
            }
        }

        // Show replication info
        async function showReplication() {
            const resultDiv = document.getElementById('replicationInfo');
            resultDiv.innerHTML = '<div class="loading"></div> ƒêang t·∫£i...';
            
            try {
                const response = await fetch(`${API_BASE}/api/cluster/ranges`);
                const data = await response.json();
                
                if (data.success) {
                    let html = '<h6>Ph√¢n b·ªë Ranges tr√™n c√°c Node:</h6>';
                    html += '<div class="range-visualization">';
                    
                    data.ranges.slice(0, 10).forEach(range => {
                        html += `
                            <div class="range-item">
                                <strong>Range ${range.range_id}</strong>
                                <br>
                                <small>Replicas: ${range.replica_count}</small>
                                <br>
                                ${range.replicas.map(r => 
                                    `<span class="replica-badge">Node ${r}</span>`
                                ).join('')}
                                <br>
                                <small>Lease holder: Node ${range.lease_holder}</small>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                    html += `<p class="mt-3"><small>Hi·ªÉn th·ªã 10/${data.count} ranges ƒë·∫ßu ti√™n</small></p>`;
                    
                    resultDiv.innerHTML = html;
                } else {
                    resultDiv.innerHTML = '<div class="alert alert-danger">L·ªói: ' + data.error + '</div>';
                }
            } catch (error) {
                resultDiv.innerHTML = '<div class="alert alert-danger">L·ªói: ' + error.message + '</div>';
            }
        }

        // Show table distribution
        async function showTableDistribution() {
            const resultDiv = document.getElementById('tableDistribution');
            resultDiv.innerHTML = '<div class="loading"></div> ƒêang t·∫£i...';
            
            try {
                const response = await fetch(`${API_BASE}/api/cluster/table-distribution`);
                const data = await response.json();
                
                if (data.success) {
                    let html = `
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>T√™n b·∫£ng</th>
                                    <th>S·ªë Ranges</th>
                                    <th>Ph√¢n b·ªë tr√™n Nodes</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    
                    data.tables.forEach(table => {
                        html += `
                            <tr>
                                <td><strong>${table.table_name}</strong></td>
                                <td>${table.range_count}</td>
                                <td>
                                    ${table.nodes.map(n => 
                                        `<span class="badge bg-success">Node ${n}</span>`
                                    ).join(' ')}
                                </td>
                            </tr>
                        `;
                    });
                    
                    html += '</tbody></table>';
                    html += `
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> 
                            D·ªØ li·ªáu ƒë∆∞·ª£c ph√¢n b·ªë t·ª± ƒë·ªông tr√™n c√°c node ƒë·ªÉ t·ªëi ∆∞u hi·ªáu su·∫•t v√† ƒë·ªô tin c·∫≠y.
                        </div>
                    `;
                    
                    resultDiv.innerHTML = html;
                } else {
                    resultDiv.innerHTML = '<div class="alert alert-danger">L·ªói: ' + data.error + '</div>';
                }
            } catch (error) {
                resultDiv.innerHTML = '<div class="alert alert-danger">L·ªói: ' + error.message + '</div>';
            }
        }

        // Run failover test
        async function runFailoverTest() {
            const resultDiv = document.getElementById('failoverResult');
            resultDiv.innerHTML = '<div class="loading"></div> ƒêang ch·∫°y test...';
            
            try {
                const response = await fetch(`${API_BASE}/api/cluster/failover-test`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    let html = `
                        <div class="alert alert-success">
                            <h6><i class="bi bi-check-circle-fill"></i> Test th√†nh c√¥ng!</h6>
                            <p><strong>Lease holder:</strong> Node ${data.lease_holder}</p>
                            <p><strong>Replicas:</strong> 
                                ${data.replicas.map(r => `<span class="badge bg-primary">Node ${r}</span>`).join(' ')}
                            </p>
                            <p class="mb-0">
                                <i class="bi bi-info-circle"></i> 
                                D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c ghi v√† sao ch√©p th√†nh c√¥ng. 
                                N·∫øu Node ${data.lease_holder} b·ªã ng·∫Øt k·∫øt n·ªëi, 
                                m·ªôt replica kh√°c s·∫Ω t·ª± ƒë·ªông tr·ªü th√†nh lease holder.
                            </p>
                        </div>
                    `;
                    resultDiv.innerHTML = html;
                } else {
                    resultDiv.innerHTML = '<div class="alert alert-danger">L·ªói: ' + data.error + '</div>';
                }
            } catch (error) {
                resultDiv.innerHTML = '<div class="alert alert-danger">L·ªói: ' + error.message + '</div>';
            }
        }

        // Check consistency
        async function checkConsistency() {
            const resultDiv = document.getElementById('consistencyResult');
            resultDiv.innerHTML = '<div class="loading"></div> ƒêang ki·ªÉm tra...';
            
            try {
                const response = await fetch(`${API_BASE}/api/cluster/consistency-check`);
                const data = await response.json();
                
                if (data.success) {
                    const alertClass = data.is_consistent ? 'alert-success' : 'alert-warning';
                    const icon = data.is_consistent ? 'check-circle-fill' : 'exclamation-triangle-fill';
                    
                    let html = `
                        <div class="alert ${alertClass}">
                            <h6><i class="bi bi-${icon}"></i> 
                                ${data.is_consistent ? 'D·ªØ li·ªáu nh·∫•t qu√°n!' : 'C·∫£nh b√°o v·ªÅ t√≠nh nh·∫•t qu√°n'}
                            </h6>
                            <table class="table table-sm mt-3 bg-white">
                                <tr>
                                    <td><strong>T·ªïng s·ªë b·ªánh nh√¢n:</strong></td>
                                    <td>${data.consistency.benhnhan_count}</td>
                                </tr>
                                <tr>
                                    <td><strong>T·ªïng s·ªë l·∫ßn kh√°m:</strong></td>
                                    <td>${data.consistency.lankham_count}</td>
                                </tr>
                                <tr>
                                    <td><strong>T·ªïng s·ªë ranges:</strong></td>
                                    <td>${data.consistency.range_count}</td>
                                </tr>
                                <tr class="${data.consistency.underreplicated > 0 ? 'table-warning' : ''}">
                                    <td><strong>Ranges ch∆∞a replicate ƒë·ªß:</strong></td>
                                    <td>${data.consistency.underreplicated}</td>
                                </tr>
                            </table>
                            ${data.is_consistent ? 
                                '<p class="mb-0">‚úì T·∫•t c·∫£ ranges ƒë√£ ƒë∆∞·ª£c replicate ƒë·∫ßy ƒë·ªß.</p>' :
                                '<p class="mb-0">‚ö† M·ªôt s·ªë ranges ch∆∞a ƒë∆∞·ª£c replicate ƒë·ªß. H·ªá th·ªëng ƒëang t·ª± ƒë·ªông sao ch√©p.</p>'
                            }
                        </div>
                    `;
                    resultDiv.innerHTML = html;
                } else {
                    resultDiv.innerHTML = '<div class="alert alert-danger">L·ªói: ' + data.error + '</div>';
                }
            } catch (error) {
                resultDiv.innerHTML = '<div class="alert alert-danger">L·ªói: ' + error.message + '</div>';
            }
        }

        // Load data on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadAllData();
            initTooltips();
        });
    </script>
</body>
</html>
